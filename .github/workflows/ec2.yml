name: AWS-EC2 Instance CD

on:
  # run automatically after your FE pipeline succeeds
  workflow_run:
    workflows: ["Node.js CI"]
    types: [completed]

  # and allow manual runs from the Actions tab, which is handy for Learner Lab
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1) Configure AWS using temp STS creds (session token supported)
      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token:     ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region:            ${{ secrets.AWS_REGION }}

      # 2) Send the SSM command to your EC2 instance
      - name: Send SSM redeploy command
        env:
          AWS_REGION:   ${{ secrets.AWS_REGION }}
          INSTANCE_IDS: ${{ secrets.AWS_INSTANCE_ID }}
        run: |
          # Build the command we want to run on the instance
          REDEPLOY_CMD='cd /home/ubuntu && \
            (sudo docker-compose pull || sudo docker compose pull) && \
            (sudo docker-compose up -d || sudo docker compose up -d) && \
            sudo docker image prune -af'

          # Send it via SSM
          CMD_ID=$(aws ssm send-command \
            --region "$AWS_REGION" \
            --instance-ids "$INSTANCE_IDS" \
            --document-name "AWS-RunShellScript" \
            --comment "Redeploy BookPortal via docker-compose" \
            --parameters commands="$REDEPLOY_CMD" \
            --query "Command.CommandId" \
            --output text)

          echo "CommandId: $CMD_ID"

          # (optional) Wait until it finishes and print output
          aws ssm wait command-executed \
            --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_IDS"

          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_IDS" \
            --query "{Status:Status, StdOut:StandardOutputContent, StdErr:StandardErrorContent}" \
            --output table
###